<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注册页面</title>
    <style>
        /* 简单的样式 */
        .message {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid transparent;
            border-radius: 5px;
            display: none; /* 默认隐藏 */
        }
        .message.success {
            border-color: green;
            background-color: #d4edda;
            color: green;
        }
        .message.error {
            border-color: red;
            background-color: #f8d7da;
            color: red;
        }
    </style>
</head>
<body>
<form id="registration-form">
    <label for="username">用户名:</label>
    <input type="text" id="username" name="username" required />

    <label for="password">密码:</label>
    <input type="password" id="password" name="password" required />

    <label for="email">邮箱:</label>
    <input type="email" id="email" name="email" required />

    <div id="extra-fields"></div>

    <button type="submit">注册</button>
</form>

<!-- 消息提示区域 -->
<div id="message" class="message"></div>

<script>
    window.onload = function() {
        // 默认选中教师角色
        const extraFields = document.getElementById("extra-fields");
        extraFields.innerHTML = `
            <label for="courses">选择课程:</label>
            <select id="courses" name="courses" multiple>
                <!-- 动态加载课程选项 -->
            </select>
        `;

        // 消息提示函数
        const showMessage = (text, type) => {
            const messageDiv = document.getElementById("message");
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = "block"; // 显示消息
            setTimeout(() => {
                messageDiv.style.display = "none"; // 自动隐藏
            }, 3000); // 3秒后隐藏
        };

        // 加载课程数据
        fetch("/api/courses")
            .then(response => response.json())
            .then(courses => {
                const coursesSelect = document.getElementById("courses");
                coursesSelect.innerHTML = '';  // 清空现有的课程选项
                if (courses && courses.length > 0) {
                    courses.forEach(course => {
                        const option = document.createElement("option");
                        option.value = course.courseId;  // 使用 courseId 作为选项的值
                        option.textContent = `${course.courseName} - ${course.courseTime}`;
                        coursesSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement("option");
                    option.textContent = "没有可用课程";
                    coursesSelect.appendChild(option);
                }
            })
            .catch(error => {
                console.error("无法加载课程数据:", error);
                showMessage("无法加载课程数据，请稍后再试！", "error");
            });

        // 提交表单时处理用户注册
        document.getElementById("registration-form").addEventListener("submit", function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            const selectedCourses = Array.from(document.getElementById("courses").selectedOptions).map(option => option.value);

            const role = 'TEACHER';  // 默认选中角色为教师(教师登录功能)
            data.role = role;

            data.courses = selectedCourses; // 添加课程数据


            console.log(data); // 输出调试

            fetch("/api/users/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
            })
                .then(response => {
                    if (response.ok) return response.text();
                    return response.text().then(text => {
                        throw new Error(text); // 如果返回非 2xx 状态，抛出错误信息
                    });
                })
                .then(message => showMessage(message, "success"))
                .catch(error => {
                    console.error("提交失败:", error);
                    showMessage(`注册失败：${responseText || '未知错误，请稍后再试'}`, "error");
                });
        });
    };
</script>
</body>
</html>
